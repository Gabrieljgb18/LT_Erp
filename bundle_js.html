<!-- Archivo generado desde /src/*. No editar. EjecutÃ¡ `node generate_bundle_html.js` para regenerar. -->
<script>
/**
 * HTML Helpers
 * Utilidades para generaciÃ³n de HTML y escape de strings
 */

(function (global) {
    const HtmlHelpers = (() => {

        /**
         * Escapa caracteres HTML para prevenir XSS
         * @param {string} str - String a escapar
         * @returns {string} String escapado
         */
        function escapeHtml(str) {
            return String(str || "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        /**
         * Genera opciones HTML para select de empleados
         * @param {string} selected - Empleado seleccionado
         * @param {Array} empleados - Lista de empleados
         * @returns {string} HTML de opciones
         */
        function getEmpleadoOptionsHtml(selected, empleados = []) {
            const opts = ['<option value="">Seleccionar...</option>'];
            empleados.forEach(emp => {
                const sel = emp === selected ? " selected" : "";
                opts.push('<option value="' + escapeHtml(emp) + '"' + sel + ">" +
                    escapeHtml(emp) + "</option>");
            });
            return opts.join("");
        }

        /**
         * Genera opciones HTML para select de dÃ­as de la semana
         * @param {string} selected - DÃ­a seleccionado
         * @returns {string} HTML de opciones
         */
        function getDiaOptionsHtml(selected) {
            const days = [
                "LUNES",
                "MARTES",
                "MIERCOLES",
                "JUEVES",
                "VIERNES",
                "SABADO",
                "DOMINGO",
            ];
            const opts = ['<option value="">DÃ­a...</option>'];
            days.forEach(d => {
                const sel = d === selected ? " selected" : "";
                opts.push('<option value="' + d + '"' + sel + ">" + d + "</option>");
            });
            return opts.join("");
        }

        /**
         * Formatea hora de entrada para input type="time"
         * @param {Date|string} horaEntrada - Hora a formatear
         * @returns {string} Hora en formato HH:MM
         */
        function formatHoraEntradaForInput(horaEntrada) {
            if (!horaEntrada) return "";

            // Si viene como Date desde Apps Script
            if (Object.prototype.toString.call(horaEntrada) === "[object Date]" && !isNaN(horaEntrada)) {
                const hh = String(horaEntrada.getHours()).padStart(2, "0");
                const mm = String(horaEntrada.getMinutes()).padStart(2, "0");
                return `${hh}:${mm}`;
            }

            // Si viene como string, tratamos de rescatar hh:mm
            const s = String(horaEntrada).trim();
            const match = s.match(/(\d{1,2}):(\d{2})/);
            if (match) {
                const hh = match[1].padStart(2, "0");
                const mm = match[2];
                return `${hh}:${mm}`;
            }

            return "";
        }

        return {
            escapeHtml,
            getEmpleadoOptionsHtml,
            getDiaOptionsHtml,
            formatHoraEntradaForInput
        };
    })();

    global.HtmlHelpers = HtmlHelpers;
})(typeof window !== "undefined" ? window : this);


(function (global) {
  // Constantes y definiciones de campos para cada formato.
  const CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutos

  const FORM_DEFINITIONS = {
    CLIENTES: {
      title: "Registro de clientes",
      fields: [
        { id: "NOMBRE", label: "Nombre", type: "text", placeholder: "Nombre del cliente" },
        { id: "ESTADO", label: "Estado", type: "boolean", trueLabel: "Activo" },
        { id: "RAZON SOCIAL", label: "RazÃ³n social", type: "text" },
        { id: "CUIT", label: "CUIT", type: "text" },
        { id: "ENCARGADO", label: "Encargado", type: "text" },
        { id: "TELEFONO", label: "TelÃ©fono", type: "phone" },
        { id: "DIRECCION", label: "DirecciÃ³n", type: "text", full: true },
        { id: "CORREO ADMINISTRACION", label: "Correo administraciÃ³n", type: "email" },
        { id: "CORREO FACTURACION", label: "Correo facturaciÃ³n", type: "email" },
        { id: "FECHA CONTRATO", label: "Fecha contrato", type: "date" },
        { id: "VALOR HORA", label: "Valor de hora", type: "number", step: "0.01" },
        { id: "LUNES HS", label: "Horas lunes", type: "number", step: "0.5" },
        { id: "MARTES HS", label: "Horas martes", type: "number", step: "0.5" },
        { id: "MIERCOLES HS", label: "Horas miÃ©rcoles", type: "number", step: "0.5" },
        { id: "JUEVES HS", label: "Horas jueves", type: "number", step: "0.5" },
        { id: "VIERNES HS", label: "Horas viernes", type: "number", step: "0.5" },
        { id: "SABADO HS", label: "Horas sÃ¡bado", type: "number", step: "0.5" },
        { id: "DOMINGO HS", label: "Horas domingo", type: "number", step: "0.5" }
      ]
    },
    EMPLEADOS: {
      title: "Registro de empleados",
      fields: [
        { id: "ESTADO", label: "Estado", type: "boolean", trueLabel: "Activo" },
        { id: "EMPLEADO", label: "Empleado", type: "text", full: true },
        { id: "CUIL", label: "CUIL", type: "text" },
        { id: "DIRECCION", label: "DirecciÃ³n", type: "text", full: true },
        { id: "TELEFONO", label: "TelÃ©fono", type: "phone" },
        { id: "CONTACTO DE EMERGENCIA", label: "Contacto de emergencia", type: "phone", full: true },
        { id: "CBU - ALIAS", label: "CBU / Alias", type: "text", full: true },
        { id: "DNI", label: "DNI", type: "dni" },
        { id: "VALOR DE HORA", label: "Valor de hora", type: "number", step: "0.01" }
      ]
    },
    FACTURACION: {
      title: "Registro de facturaciÃ³n",
      fields: [
        { id: "FECHA", label: "Fecha", type: "date" },
        { id: "COMPROBANTE", label: "Comprobante", type: "text" },
        { id: "NUMERO", label: "NÃºmero", type: "text" },
        { id: "RAZÃ“N SOCIAL", label: "RazÃ³n social", type: "cliente", full: true },
        { id: "CUIT", label: "CUIT", type: "text" },
        { id: "IMPORTE", label: "Importe", type: "number", step: "0.01" },
        { id: "SUBTOTAL", label: "Subtotal", type: "number", step: "0.01" },
        { id: "TOTAL", label: "Total", type: "number", step: "0.01" }
      ]
    },
    PAGOS: {
      title: "Registro de pagos",
      fields: [
        { id: "FECHA", label: "Fecha", type: "date" },
        { id: "RAZÃ“N SOCIAL", label: "RazÃ³n social", type: "cliente", full: true },
        { id: "CUIT", label: "CUIT", type: "text" },
        { id: "DETALLE", label: "Detalle", type: "text", full: true },
        { id: "NÂ° COMPROBANTE", label: "NÂº comprobante", type: "text" },
        { id: "MEDIO DE PAGO", label: "Medio de pago", type: "text" },
        { id: "MONTO", label: "Monto", type: "number", step: "0.01" }
      ]
    },
    ASISTENCIA_PLAN: {
      title: "Plan de asistencia semanal",
      fields: [
        { id: "CLIENTE", label: "Cliente", type: "cliente", full: true },
        { id: "EMPLEADO", label: "Empleado", type: "empleado", full: true },
        { id: "DIA SEMANA", label: "DÃ­a de la semana", type: "select", options: ["Lunes", "Martes", "MiÃ©rcoles", "Jueves", "Viernes", "SÃ¡bado", "Domingo"] },
        { id: "HORA ENTRADA", label: "Hora de entrada", type: "time" },
        { id: "HORAS PLAN", label: "Horas planificadas", type: "number", step: "0.5" },
        { id: "ACTIVO", label: "Activo", type: "boolean", trueLabel: "Activo" },
        { id: "OBSERVACIONES", label: "Observaciones", type: "textarea", full: true }
      ]
    },
    ASISTENCIA: {
      title: "Registro de asistencia",
      fields: [
        { id: "FECHA", label: "Fecha", type: "date" },
        { id: "EMPLEADO", label: "Empleado", type: "empleado", full: true },
        { id: "CLIENTE", label: "Cliente", type: "cliente", full: true },
        { id: "ASISTENCIA", label: "Asistencia", type: "boolean", trueLabel: "Presente" },
        { id: "HORAS", label: "Horas trabajadas", type: "number", step: "0.5" },
        { id: "OBSERVACIONES", label: "Observaciones", type: "textarea", full: true }
      ]
    }
  };

  global.CACHE_TTL_MS = CACHE_TTL_MS;
  global.FORM_DEFINITIONS = FORM_DEFINITIONS;
})(typeof window !== "undefined" ? window : this);


(function (global) {
  // Wrappers para llamadas a google.script.run con control de concurrencia.
  const ApiService = (() => {
    const latestTokens = new Map();
    const dataCache = {
      reference: null,
      referenceTs: 0,
      search: new Map() // key: format|query -> {ts, results}
    };

    function call(functionName, ...args) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)[functionName](...args);
      });
    }

    function callLatest(key, functionName, ...args) {
      const token = Date.now() + "-" + Math.random().toString(16).slice(2);
      latestTokens.set(key, token);
      return call(functionName, ...args)
        .then((res) => {
          if (latestTokens.get(key) !== token) {
            return { ignored: true };
          }
          return res;
        })
        .catch((err) => {
          if (latestTokens.get(key) !== token) {
            return { ignored: true };
          }
          throw err;
        });
    }

    return {
      call,
      callLatest,
      dataCache
    };
  })();

  global.ApiService = ApiService;
})(typeof window !== "undefined" ? window : this);


(function (global) {
  // Manejo de datos de referencia (clientes/empleados) con cache.
  const ReferenceService = (() => {
    const state = {
      data: { clientes: [], empleados: [] },
      loaded: false
    };

    function load() {
      const now = Date.now();
      if (
        ApiService.dataCache.reference &&
        now - ApiService.dataCache.referenceTs < CACHE_TTL_MS
      ) {
        state.data = ApiService.dataCache.reference;
        state.loaded = true;
        return Promise.resolve(state.data);
      }

      return ApiService.call("getReferenceData")
        .then(function (data) {
          if (data && data.ignored) return;
          state.data = data || { clientes: [], empleados: [] };
          ApiService.dataCache.reference = state.data;
          ApiService.dataCache.referenceTs = Date.now();
        })
        .catch(function (err) {
          console.error("Error obteniendo referencia:", err);
          state.data = { clientes: [], empleados: [] };
        })
        .finally(function () {
          state.loaded = true;
        });
    }

    function get() {
      return state.data;
    }

    function isLoaded() {
      return state.loaded;
    }

    return {
      load,
      get,
      isLoaded
    };
  })();

  global.ReferenceService = ReferenceService;
})(typeof window !== "undefined" ? window : this);


(function (global) {
  // Metadata y helpers por formato (CLIENTES, EMPLEADOS, etc.)
  const DEFAULTS = {
    entity: "registro",
    label: function (record) {
      return "";
    },
    refreshReference: false
  };

  const META_BY_FORMAT = {
    CLIENTES: {
      entity: "cliente",
      label: function (record) {
        return record["NOMBRE"] || "";
      },
      refreshReference: true
    },
    EMPLEADOS: {
      entity: "empleado",
      label: function (record) {
        return record["EMPLEADO"] || "";
      },
      refreshReference: true
    },
    FACTURACION: {
      entity: "comprobante",
      label: function (record) {
        return (
          record["COMPROBANTE"] ||
          record["NÃšMERO"] ||
          record["RAZÃ“N SOCIAL"] ||
          ""
        );
      }
    },
    PAGOS: {
      entity: "pago",
      label: function (record) {
        return record["RAZÃ“N SOCIAL"] || "";
      }
    },
    ASISTENCIA: {
      entity: "registro de asistencia",
      label: function (record) {
        return record["EMPLEADO"] || record["CLIENTE"] || "";
      }
    },
    ASISTENCIA_PLAN: {
      entity: "plan de asistencia",
      label: function (record) {
        return record["EMPLEADO"] || record["CLIENTE"] || "";
      }
    }
  };

  function getMeta(format) {
    return META_BY_FORMAT[format] || DEFAULTS;
  }

  global.DomainMeta = {
    getMeta
  };
})(typeof window !== "undefined" ? window : this);


(function (global) {
  function clearAlerts() {
    const c = document.getElementById("alert-container");
    if (c) c.innerHTML = "";
  }

  function showAlert(message, type = "info") {
    const container = document.getElementById("alert-container");
    if (!container) return;
    container.innerHTML = "";

    const div = document.createElement("div");
    div.className =
      "alert alert-" +
      type +
      " alert-dismissible fade show py-2 px-3 mb-2";
    div.setAttribute("role", "alert");

    div.innerHTML =
      '<div class="small">' +
      message +
      '</div><button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>';

    container.appendChild(div);
  }

  global.Alerts = {
    clearAlerts,
    showAlert
  };
})(typeof window !== "undefined" ? window : this);


(function (global) {
  function toggleControls(disabled) {
    // Don't disable search-query so users can keep typing during search
    ["formato", "btn-nuevo"].forEach(function (id) {
      var el = document.getElementById(id);
      if (el) el.disabled = !!disabled;
    });
  }

  const UiState = {
    renderLoading: function (componentId, title, message) {
      const c = document.getElementById(componentId);
      if (!c) return;
      c.innerHTML =
        '<div class="mt-2 p-2 border rounded bg-light">' +
        '<div class="small fw-bold mb-1">' +
        title +
        "</div>" +
        '<div class="small text-muted">' +
        message +
        "</div>" +
        "</div>";
    },
    setGlobalLoading: function (isLoading, message) {
      const badge = document.getElementById("global-loading");
      const btn = document.getElementById("btn-grabar");
      toggleControls(isLoading);
      if (btn) btn.disabled = !!isLoading;
      if (!badge) return;
      if (isLoading) {
        badge.classList.remove("d-none");
        badge.innerHTML =
          '<div class="spinner-border spinner-border-sm me-2" role="status"></div>' +
          '<span class="small">' +
          (message || "Procesando...") +
          "</span>";
      } else {
        badge.classList.add("d-none");
        badge.innerHTML = "";
      }
    }
  };

  global.UiState = UiState;
})(typeof window !== "undefined" ? window : this);


(function (global) {
  // Renderers de campos segÃºn tipo. Devuelven nodos listos para insertar.
  function renderBoolean(field) {
    const wrapper = document.createElement("div");
    wrapper.className = "mb-1";

    const label = document.createElement("label");
    label.className = "form-label mb-1";
    label.htmlFor = "field-" + field.id;
    label.textContent = field.label;

    const switchDiv = document.createElement("div");
    switchDiv.className = "form-check form-switch";

    const input = document.createElement("input");
    input.type = "checkbox";
    input.className = "form-check-input";
    input.id = "field-" + field.id;
    input.checked = true;

    const switchLabel = document.createElement("label");
    switchLabel.className = "form-check-label small";
    switchLabel.htmlFor = input.id;
    switchLabel.textContent = field.trueLabel || "Activo";

    switchDiv.appendChild(input);
    switchDiv.appendChild(switchLabel);

    wrapper.appendChild(label);
    wrapper.appendChild(switchDiv);
    return wrapper;
  }

  function renderDayOfWeek(field) {
    const wrapper = document.createElement("div");
    wrapper.className = "mb-1";

    const label = document.createElement("label");
    label.className = "form-label mb-1";
    label.htmlFor = "field-" + field.id;
    label.textContent = field.label;

    const input = document.createElement("select");
    input.id = "field-" + field.id;
    input.className = "form-select form-select-sm";

    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Seleccionar dÃ­a...";
    input.appendChild(placeholder);

    const days = [
      "LUNES",
      "MARTES",
      "MIERCOLES",
      "JUEVES",
      "VIERNES",
      "SABADO",
      "DOMINGO"
    ];

    days.forEach((d) => {
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      input.appendChild(opt);
    });

    wrapper.appendChild(label);
    wrapper.appendChild(input);
    return wrapper;
  }

  function renderDeclarativeSelect(field, options) {
    const wrapper = document.createElement("div");
    wrapper.className = "mb-1";

    const label = document.createElement("label");
    label.className = "form-label mb-1";
    label.htmlFor = "field-" + field.id;
    label.textContent = field.label;

    const input = document.createElement("select");
    input.id = "field-" + field.id;
    input.className = "form-select form-select-sm";

    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Seleccionar...";
    input.appendChild(placeholder);

    options.forEach((optItem) => {
      const opt = document.createElement("option");
      opt.value = optItem.value;
      opt.textContent = optItem.label;
      if (optItem.dataset) {
        Object.keys(optItem.dataset).forEach((k) => {
          opt.dataset[k] = optItem.dataset[k];
        });
      }
      input.appendChild(opt);
    });

    wrapper.appendChild(label);
    wrapper.appendChild(input);
    return wrapper;
  }

  function renderInput(field) {
    const wrapper = document.createElement("div");
    wrapper.className = "mb-1";

    const label = document.createElement("label");
    label.className = "form-label mb-1";
    label.htmlFor = "field-" + field.id;
    label.textContent = field.label;

    const input = document.createElement("input");
    input.id = "field-" + field.id;
    input.className = "form-control form-control-sm";
    input.type =
      field.type === "phone" || field.type === "dni" ? "text" : field.type;
    if (field.step) input.step = field.step;
    if (field.placeholder) input.placeholder = field.placeholder;

    wrapper.appendChild(label);
    wrapper.appendChild(input);
    return wrapper;
  }

  const FormRenderer = {
    renderField: function (field, referenceData) {
      switch (field.type) {
        case "boolean":
          return renderBoolean(field);
        case "dayOfWeek":
          return renderDayOfWeek(field);
        case "cliente": {
          const options =
            (referenceData.clientes || []).map((cli) => ({
              value: cli.razonSocial || cli.nombre,
              label: cli.razonSocial || cli.nombre,
              dataset: { cuit: cli.cuit || "" }
            })) || [];
          return renderDeclarativeSelect(field, options);
        }
        case "empleado": {
          const options =
            (referenceData.empleados || []).map((emp) => ({
              value: emp,
              label: emp
            })) || [];
          return renderDeclarativeSelect(field, options);
        }
        case "select": {
          // Select con opciones definidas en el campo
          const options = (field.options || []).map(opt => ({
            value: opt,
            label: opt
          }));
          return renderDeclarativeSelect(field, options);
        }
        case "textarea": {
          // Textarea para textos largos
          const wrapper = document.createElement("div");
          wrapper.className = "mb-1";

          const label = document.createElement("label");
          label.className = "form-label mb-1";
          label.htmlFor = "field-" + field.id;
          label.textContent = field.label;

          const textarea = document.createElement("textarea");
          textarea.id = "field-" + field.id;
          textarea.className = "form-control form-control-sm";
          textarea.rows = field.rows || 3;
          if (field.placeholder) textarea.placeholder = field.placeholder;

          wrapper.appendChild(label);
          wrapper.appendChild(textarea);
          return wrapper;
        }
        case "time": {
          // Input type time
          const wrapper = document.createElement("div");
          wrapper.className = "mb-1";

          const label = document.createElement("label");
          label.className = "form-label mb-1";
          label.htmlFor = "field-" + field.id;
          label.textContent = field.label;

          const input = document.createElement("input");
          input.id = "field-" + field.id;
          input.className = "form-control form-control-sm";
          input.type = "time";

          wrapper.appendChild(label);
          wrapper.appendChild(input);
          return wrapper;
        }
        default:
          return renderInput(field);
      }
    }
  };

  global.FormRenderer = FormRenderer;
})(typeof window !== "undefined" ? window : this);


/**
 * Footer UI Component
 */
(function (global) {
    const Footer = (function () {
        const footerHtml = `
            <footer class="fixed-bottom bg-white border-top py-2">
                <div class="container d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2">
                        <button id="btn-nuevo" class="btn btn-primary rounded-pill px-4">
                            <i class="bi bi-plus-lg me-1"></i> Nuevo
                        </button>
                    </div>
                    <button id="btn-grabar" class="btn btn-success rounded-pill px-4" disabled>
                        <i class="bi bi-check-lg me-1"></i> Grabar
                    </button>
                </div>
            </footer>
        `;

        function render() {
            const container = document.getElementById('footer-container');
            if (container) {
                container.innerHTML = footerHtml;
                attachEvents();
            }
        }

        function attachEvents() {
            const btnNuevo = document.getElementById('btn-nuevo');
            const btnGrabar = document.getElementById('btn-grabar');

            if (btnNuevo) {
                btnNuevo.addEventListener('click', function () {
                    if (global.FormManager) {
                        global.FormManager.resetForm();
                    }

                    // Reset buttons
                    btnGrabar.disabled = false;
                    btnNuevo.disabled = true;
                });
            }

            if (btnGrabar) {
                btnGrabar.addEventListener('click', function () {
                    if (global.FormManager) {
                        global.FormManager.submitForm();
                    }
                });
            }
        }

        return {
            render: render
        };
    })();

    global.Footer = Footer;
})(typeof window !== "undefined" ? window : this);


/**
 * Sidebar Component
 * Handles the responsive sidebar navigation logic
 */
const Sidebar = (() => {
    // State
    let isOpen = false;
    let activeItem = null;

    // DOM Elements
    const elements = {
        sidebar: null,
        overlay: null,
        toggleBtn: null,
        menuItems: []
    };

    /**
     * Initialize the sidebar
     */
    function init() {
        elements.sidebar = document.getElementById('app-sidebar');
        elements.overlay = document.getElementById('sidebar-overlay');
        elements.toggleBtn = document.getElementById('sidebar-toggle');

        if (!elements.sidebar) return;

        // Setup event listeners
        if (elements.toggleBtn) {
            elements.toggleBtn.addEventListener('click', toggle);
        }

        if (elements.overlay) {
            elements.overlay.addEventListener('click', close);
        }

        // Setup menu items
        const links = elements.sidebar.querySelectorAll('.nav-link');
        links.forEach(link => {
            link.addEventListener('click', (e) => {
                const targetId = link.getAttribute('data-target');
                if (targetId) {
                    setActive(targetId);
                    // On mobile, close sidebar after selection
                    if (window.innerWidth < 992) {
                        close();
                    }
                }
            });
            elements.menuItems.push(link);
        });
    }

    /**
     * Toggle sidebar state
     */
    function toggle() {
        isOpen = !isOpen;
        updateState();
    }

    /**
     * Open sidebar
     */
    function open() {
        isOpen = true;
        updateState();
    }

    /**
     * Close sidebar
     */
    function close() {
        isOpen = false;
        updateState();
    }

    /**
     * Update DOM based on state
     */
    function updateState() {
        if (isOpen) {
            document.body.classList.add('sidebar-open');
        } else {
            document.body.classList.remove('sidebar-open');
        }
    }

    /**
     * Set active menu item
     * @param {string} targetId - ID of the target view
     */
    function setActive(targetId) {
        activeItem = targetId;

        // Update menu items
        elements.menuItems.forEach(item => {
            if (item.getAttribute('data-target') === targetId) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });

        // Trigger custom event for view change
        const event = new CustomEvent('view-change', {
            detail: { view: targetId }
        });
        document.dispatchEvent(event);
    }

    return {
        init,
        toggle,
        open,
        close,
        setActive
    };
})();


/**
 * Grid Manager
 * Maneja la visualizaciÃ³n de datos en formato de grilla/tabla
 */

(function (global) {
    const GridManager = (() => {
        let currentFormat = null;
        let allRecords = [];
        let currentEditingRecord = null;

        /**
         * Renderiza la grilla con los registros del formato actual
         */
        function renderGrid(tipoFormato, records) {
            currentFormat = tipoFormato;

            // Los registros vienen en formato {id, rowNumber, record}
            // Extraer solo los records y agregar el ID
            allRecords = (records || []).map(item => {
                if (item.record) {
                    // Agregar el ID al record para poder usarlo despuÃ©s
                    item.record.ID = item.id;
                    item.record._rowNumber = item.rowNumber;
                    return item.record;
                }
                return item;
            });

            const formDef = FORM_DEFINITIONS[tipoFormato];
            if (!formDef) return;

            // Obtener los 5 campos mÃ¡s relevantes
            const relevantFields = formDef.fields.slice(0, 5);

            // Renderizar headers
            const headersRow = document.getElementById('grid-headers');
            if (headersRow) {
                headersRow.innerHTML = '';

                relevantFields.forEach(field => {
                    const th = document.createElement('th');
                    th.textContent = field.label;
                    headersRow.appendChild(th);
                });

                // Columna de acciones
                const thActions = document.createElement('th');
                thActions.textContent = 'Acciones';
                thActions.style.width = '150px';
                thActions.style.textAlign = 'center';
                headersRow.appendChild(thActions);
            }

            // Renderizar body
            const tbody = document.getElementById('grid-body');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (!allRecords.length) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = relevantFields.length + 1;
                td.className = 'text-center text-muted py-5';
                td.textContent = 'No hay registros para mostrar';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            allRecords.forEach(record => {
                const tr = document.createElement('tr');

                relevantFields.forEach(field => {
                    const td = document.createElement('td');
                    // Buscar el valor usando el ID del campo (puede estar en mayÃºsculas o minÃºsculas)
                    let value = record[field.id];

                    // Si no encuentra, intentar con el label
                    if (value === undefined || value === null) {
                        value = record[field.label];
                    }

                    // Si aÃºn no encuentra, intentar buscar case-insensitive
                    if (value === undefined || value === null) {
                        const keys = Object.keys(record);
                        const matchingKey = keys.find(k => k.toUpperCase() === field.id.toUpperCase());
                        if (matchingKey) {
                            value = record[matchingKey];
                        }
                    }

                    // Formatear segÃºn el tipo
                    if (field.type === 'boolean') {
                        value = value ? 'âœ… Activo' : 'âŒ Inactivo';
                    } else if (field.type === 'date' && value) {
                        try {
                            value = new Date(value).toLocaleDateString('es-ES');
                        } catch (e) {
                            // Mantener el valor original si no se puede convertir
                        }
                    } else if (field.type === 'number' && value) {
                        value = Number(value).toLocaleString('es-ES');
                    }

                    td.textContent = value || '-';
                    td.style.maxWidth = '200px';
                    td.style.overflow = 'hidden';
                    td.style.textOverflow = 'ellipsis';
                    td.style.whiteSpace = 'nowrap';
                    tr.appendChild(td);
                });

                // Botones de acciÃ³n - inline y mÃ¡s pequeÃ±os
                const tdActions = document.createElement('td');
                tdActions.style.textAlign = 'center';
                tdActions.style.whiteSpace = 'nowrap';

                const btnEdit = document.createElement('button');
                btnEdit.className = 'btn btn-sm btn-primary me-1';
                btnEdit.style.padding = '0.25rem 0.5rem';
                btnEdit.style.fontSize = '0.75rem';
                btnEdit.innerHTML = 'âœï¸';
                btnEdit.title = 'Editar';
                btnEdit.onclick = () => editRecord(record);

                const btnDelete = document.createElement('button');
                btnDelete.className = 'btn btn-sm btn-danger';
                btnDelete.style.padding = '0.25rem 0.5rem';
                btnDelete.style.fontSize = '0.75rem';
                btnDelete.innerHTML = 'ðŸ—‘ï¸';
                btnDelete.title = 'Eliminar';
                btnDelete.onclick = () => deleteRecord(record);

                tdActions.appendChild(btnEdit);
                tdActions.appendChild(btnDelete);
                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            });
        }

        /**
         * Abre el modal para editar un registro
         */
        function editRecord(record) {
            currentEditingRecord = record;

            // Abrir modal y renderizar formulario en el callback
            openModal('Editar Registro', function () {
                if (FormManager) {
                    FormManager.renderForm(currentFormat);

                    // Esperar un momento adicional para que se rendericen los campos
                    setTimeout(() => {
                        loadRecordIntoForm(record);

                        // Mostrar botÃ³n eliminar
                        const btnEliminar = document.getElementById('btn-eliminar-modal');
                        if (btnEliminar) {
                            btnEliminar.classList.remove('d-none');
                        }
                    }, 100);
                }
            });
        }

        /**
         * Carga los datos del registro en el formulario
         */
        function loadRecordIntoForm(record) {
            const formDef = FORM_DEFINITIONS[currentFormat];
            if (!formDef) return;

            formDef.fields.forEach(field => {
                const input = document.getElementById('field-' + field.id);
                if (!input) return;

                const value = record[field.id];

                if (field.type === 'boolean') {
                    input.checked = !!value;
                } else if (field.type === 'date' && value) {
                    // Convertir fecha a formato YYYY-MM-DD
                    const date = new Date(value);
                    input.value = date.toISOString().split('T')[0];
                } else {
                    input.value = value || '';
                }
            });
        }

        /**
         * Elimina un registro
         */
        function deleteRecord(record) {
            if (!confirm('Â¿EstÃ¡s seguro de que deseas eliminar este registro?')) {
                return;
            }

            // AquÃ­ irÃ­a la lÃ³gica de eliminaciÃ³n
            if (RecordManager) {
                // Simular clic en eliminar con el registro cargado
                currentEditingRecord = record;
                RecordManager.deleteRecord();
            }
        }

        /**
         * Abre el modal del formulario
         * @param {string} title - TÃ­tulo del modal
         * @param {function} callback - FunciÃ³n a ejecutar despuÃ©s de abrir el modal
         */
        function openModal(title, callback) {
            const modal = document.getElementById('form-modal');
            const modalTitle = document.getElementById('modal-title');

            if (modal) {
                modal.classList.remove('d-none');
            }

            if (modalTitle) {
                modalTitle.textContent = title || 'Nuevo Registro';
            }

            // Ejecutar callback despuÃ©s de que el modal estÃ© visible
            if (callback && typeof callback === 'function') {
                setTimeout(callback, 50);
            }
        }

        /**
         * Cierra el modal del formulario
         */
        function closeModal() {
            const modal = document.getElementById('form-modal');
            if (modal) {
                modal.classList.add('d-none');
            }

            currentEditingRecord = null;

            // Limpiar formulario
            if (FormManager) {
                FormManager.clearForm();
            }

            // Ocultar botÃ³n eliminar
            const btnEliminar = document.getElementById('btn-eliminar-modal');
            if (btnEliminar) {
                btnEliminar.classList.add('d-none');
            }
        }

        /**
         * Obtiene el registro que se estÃ¡ editando actualmente
         */
        function getCurrentEditingRecord() {
            return currentEditingRecord;
        }

        /**
         * Recarga los datos de la grilla
         */
        function refreshGrid() {
            if (!currentFormat) return;

            // AquÃ­ irÃ­a la lÃ³gica para recargar los datos desde el servidor
            if (ApiService) {
                ApiService.call('searchRecords', currentFormat, '')
                    .then(records => {
                        renderGrid(currentFormat, records);
                    })
                    .catch(err => {
                        console.error('Error al recargar la grilla:', err);
                    });
            }
        }

        return {
            renderGrid,
            openModal,
            closeModal,
            getCurrentEditingRecord,
            refreshGrid
        };
    })();

    global.GridManager = GridManager;
})(typeof window !== 'undefined' ? window : this);


/**
 * Search Manager
 * Maneja la bÃºsqueda de registros
 */

(function (global) {
    const SearchManager = (() => {
        let searchDebounce = null;
        let suggestionResults = [];

        /**
         * Builds a preview string for a search result based on its content
         */
        function buildPreview(record) {
            const parts = [];

            // Always show ID first if available
            if (record.ID) {
                parts.push(`<strong>ID:</strong> ${record.ID}`);
            }

            // Format-specific key fields
            if (record.NOMBRE) {
                parts.push(`<strong>NOMBRE:</strong> ${record.NOMBRE}`);
            } else if (record.EMPLEADO) {
                parts.push(`<strong>EMPLEADO:</strong> ${record.EMPLEADO}`);
            } else if (record.CLIENTE) {
                parts.push(`<strong>CLIENTE:</strong> ${record.CLIENTE}`);
            }

            // Additional context field
            if (record["RAZON SOCIAL"]) {
                parts.push(`<strong>RAZÃ“N SOCIAL:</strong> ${record["RAZON SOCIAL"]}`);
            } else if (record.CUIT) {
                parts.push(`<strong>CUIT:</strong> ${record.CUIT}`);
            } else if (record.CUIL) {
                parts.push(`<strong>CUIL:</strong> ${record.CUIL}`);
            } else if (record.FECHA) {
                parts.push(`<strong>FECHA:</strong> ${record.FECHA}`);
            }

            // If we don't have enough parts, add first non-ID field
            if (parts.length < 2) {
                const keys = Object.keys(record).filter(k => k !== 'ID');
                if (keys.length > 0) {
                    parts.push(`<strong>${keys[0]}:</strong> ${record[keys[0]]}`);
                }
            }

            return parts.join(" Â· ");
        }

        function handleSearch(tipoFormato, query) {
            if (searchDebounce) {
                clearTimeout(searchDebounce);
            }

            const sugg = document.getElementById("search-suggestions");
            if (!sugg) return;

            if (!query || query.length < 2) {
                sugg.classList.add("d-none");
                sugg.innerHTML = "";
                return;
            }

            UiState.setGlobalLoading(true, "Buscando...");

            searchDebounce = setTimeout(function () {
                ApiService.callLatest('search-' + tipoFormato, 'searchRecords', tipoFormato, query)
                    .then(function (results) {
                        if (results && results.ignored) return;
                        suggestionResults = results || [];
                        renderSearchResults(suggestionResults);
                    })
                    .catch(function (err) {
                        console.error("Error en bÃºsqueda:", err);
                        if (Alerts) Alerts.showAlert("Error al buscar: " + err.message, "danger");
                    })
                    .finally(function () {
                        UiState.setGlobalLoading(false);
                    });
            }, 300);
        }

        function renderSearchResults(results) {
            const sugg = document.getElementById("search-suggestions");
            if (!sugg) return;

            if (!results.length) {
                sugg.classList.add("d-none");
                sugg.innerHTML = "";
                return;
            }

            sugg.classList.remove("d-none");
            const list = document.createElement("ul");
            list.className = "list-group list-group-flush";

            results.slice(0, 10).forEach(function (item, idx) {
                const li = document.createElement("li");
                li.className = "list-group-item list-group-item-action p-2 cursor-pointer";
                li.setAttribute("data-suggestion-idx", idx);

                // Build format-specific preview
                const preview = buildPreview(item.record);

                li.innerHTML = `<small>${preview}</small>`;
                list.appendChild(li);
            });

            sugg.innerHTML = "";
            sugg.appendChild(list);

            sugg.addEventListener("click", function (e) {
                const li = e.target.closest("[data-suggestion-idx]");
                if (li) {
                    const idx = parseInt(li.getAttribute("data-suggestion-idx"));
                    selectSearchResult(idx);
                }
            });
        }

        function selectSearchResult(idx) {
            if (!suggestionResults[idx]) return;

            const item = suggestionResults[idx];
            if (global.RecordManager) {
                // Pass id instead of rowNumber
                global.RecordManager.loadRecordForEdit(item.id, item.record);
            }

            clearSearch();
        }

        function clearSearch() {
            const searchInput = document.getElementById("search-query");
            const sugg = document.getElementById("search-suggestions");

            if (searchInput) searchInput.value = "";
            if (sugg) {
                sugg.classList.add("d-none");
                sugg.innerHTML = "";
            }

            suggestionResults = [];
        }

        return {
            handleSearch,
            clearSearch
        };
    })();

    global.SearchManager = SearchManager;
})(typeof window !== "undefined" ? window : this);


/**
 * Weekly Plan Panel
 * UI para gestiÃ³n de planificaciÃ³n semanal de asistencia
 */

(function (global) {
    const WeeklyPlanPanel = (() => {
        let referenceData = { clientes: [], empleados: [] };

        function init(refData) {
            referenceData = refData;
        }

        function setup() {
            const container = document.getElementById("form-fields");
            if (!container) return;

            let panel = document.getElementById("plan-semanal-panel");
            if (!panel) {
                panel = document.createElement("div");
                panel.id = "plan-semanal-panel";
                panel.className = "mt-2";
                container.appendChild(panel);
            }

            panel.innerHTML =
                '<div class="mt-2 p-2 border rounded bg-light">' +
                '<div class="small fw-bold mb-1">Plan semanal del cliente</div>' +
                '<div class="small text-muted">ElegÃ­ un cliente para ver y editar todas las asignaciones semanales de una sola vez.</div>' +
                '</div>';

            const clienteSelect = document.getElementById("field-CLIENTE");
            if (clienteSelect) {
                clienteSelect.addEventListener("change", fetchWeeklyPlanForClient);
            }
        }

        function fetchWeeklyPlanForClient() {
            const panel = document.getElementById("plan-semanal-panel");
            const clienteSelect = document.getElementById("field-CLIENTE");
            if (!panel || !clienteSelect) return;

            const cliente = clienteSelect.value;
            if (!cliente) {
                UiState.renderLoading(
                    "plan-semanal-panel",
                    "Plan semanal del cliente",
                    "ElegÃ­ un cliente para ver su plan."
                );
                return;
            }

            UiState.renderLoading(
                "plan-semanal-panel",
                "Plan semanal del cliente",
                "Cargando plan de <strong>" + HtmlHelpers.escapeHtml(cliente) + "</strong>..."
            );

            ApiService.callLatest('weekly-plan-' + cliente, 'getWeeklyPlanForClient', cliente)
                .then(function (rows) {
                    if (rows && rows.ignored) return;
                    const planRows = Array.isArray(rows) ? rows : [];
                    const currentClienteEl = document.getElementById("field-CLIENTE");
                    const currentCliente = currentClienteEl ? currentClienteEl.value : '';
                    if (currentCliente !== cliente) return;

                    return ApiService.callLatest('weekly-hours-' + cliente, 'getClientWeeklyRequestedHours', cliente)
                        .then(function (infoHoras) {
                            if (infoHoras && infoHoras.ignored) return;
                            buildWeeklyPlanPanel(planRows, cliente, infoHoras || null);
                        })
                        .catch(function (err2) {
                            console.error("Error obteniendo horas pedidas:", err2);
                            buildWeeklyPlanPanel(planRows, cliente, null);
                        });
                })
                .catch(function (err) {
                    UiState.renderLoading(
                        "plan-semanal-panel",
                        "Plan semanal del cliente",
                        "Error al cargar plan: " + HtmlHelpers.escapeHtml(err.message)
                    );
                });
        }

        function buildWeeklyPlanPanel(rows, cliente, infoHoras) {
            const panel = document.getElementById("plan-semanal-panel");
            if (!panel) return;

            if (!rows.length) {
                rows = [{
                    empleado: "",
                    diaSemana: "",
                    horaEntrada: "",
                    horasPlan: "",
                    activo: true,
                    observaciones: ""
                }];
            }

            let html = "";
            html += '<div class="mt-2 p-2 border rounded bg-light">';
            html += '<div class="small fw-bold mb-1">Plan semanal del cliente</div>';
            html +=
                '<div class="small mb-2">Cliente: <strong>' +
                HtmlHelpers.escapeHtml(cliente) +
                "</strong></div>";

            if (infoHoras) {
                const partes = [];
                const pushSiTieneHoras = (label, valor) => {
                    const num = Number(valor || 0);
                    if (num > 0) {
                        partes.push(label + ': <strong>' + num + ' hs</strong>');
                    }
                };

                pushSiTieneHoras('Lu', infoHoras.lunes);
                pushSiTieneHoras('Ma', infoHoras.martes);
                pushSiTieneHoras('Mi', infoHoras.miercoles);
                pushSiTieneHoras('Ju', infoHoras.jueves);
                pushSiTieneHoras('Vi', infoHoras.viernes);
                pushSiTieneHoras('Sa', infoHoras.sabado);
                pushSiTieneHoras('Do', infoHoras.domingo);

                if (partes.length) {
                    html +=
                        '<div class="small text-muted mb-2">' +
                        'Horas contratadas Â· ' +
                        partes.join(' Â· ') +
                        '</div>';
                }
            }

            html += '<div class="table-responsive">';
            html +=
                '<table class="table table-sm table-bordered align-middle mb-2">' +
                "<thead>" +
                "<tr>" +
                '<th class="small">Empleado</th>' +
                '<th class="small text-center">DÃ­a</th>' +
                '<th class="small text-center">Hora entrada</th>' +
                '<th class="small text-center">Horas plan</th>' +
                '<th class="small text-center">Activo</th>' +
                '<th class="small">Observaciones</th>' +
                '<th class="small text-center" style="width:60px;">Acciones</th>' +
                "</tr>" +
                "</thead><tbody></tbody></table></div>";

            html +=
                '<div class="d-flex justify-content-between align-items-center mt-2">' +
                '<button type="button" class="btn btn-outline-secondary btn-sm btn-app" ' +
                'data-action="add-plan-row">+ Agregar fila</button>' +
                '<button type="button" class="btn btn-success btn-sm btn-app" ' +
                'data-action="save-weekly-plan">Guardar plan del cliente</button>' +
                "</div>";

            html += "</div>";

            panel.innerHTML = html;

            const tbody = panel.querySelector("tbody");
            if (tbody) {
                const frag = document.createDocumentFragment();
                rows.forEach(function (r, idx) {
                    const rowId = "plan-row-" + idx;
                    const empleadoOptions = HtmlHelpers.getEmpleadoOptionsHtml(r.empleado || "", referenceData.empleados);
                    const diaOptions = HtmlHelpers.getDiaOptionsHtml(r.diaSemana || "");
                    const checkedActivo = r.activo ? "checked" : "";
                    const horaFormatted = HtmlHelpers.formatHoraEntradaForInput(r.horaEntrada);

                    const tr = document.createElement("tr");
                    tr.setAttribute("data-idx", idx);
                    tr.innerHTML =
                        "<td>" +
                        '<select class="form-select form-select-sm" ' +
                        'id="' + rowId + '-empleado">' +
                        empleadoOptions +
                        "</select>" +
                        "</td>" +
                        "<td>" +
                        '<select class="form-select form-select-sm text-center" ' +
                        'id="' + rowId + '-dia">' +
                        diaOptions +
                        "</select>" +
                        "</td>" +
                        "<td>" +
                        '<input type="time" class="form-control form-control-sm text-center" ' +
                        'id="' + rowId + '-hora" value="' +
                        HtmlHelpers.escapeHtml(horaFormatted) +
                        '" step="1800">' +
                        "</td>" +
                        "<td>" +
                        '<input type="number" step="0.5" min="0" ' +
                        'class="form-control form-control-sm text-end" ' +
                        'id="' + rowId + '-horas" value="' +
                        HtmlHelpers.escapeHtml(r.horasPlan != null ? String(r.horasPlan) : "") +
                        '">' +
                        "</td>" +
                        "<td class='text-center'>" +
                        '<input type="checkbox" class="form-check-input" ' +
                        'id="' + rowId + '-activo" ' + checkedActivo + ">" +
                        "</td>" +
                        "<td>" +
                        '<input type="text" class="form-control form-control-sm" ' +
                        'id="' + rowId + '-obs" value="' +
                        HtmlHelpers.escapeHtml(r.observaciones || "") +
                        '">' +
                        "</td>" +
                        "<td class='text-center'>" +
                        '<button type="button" class="btn btn-outline-danger btn-sm" ' +
                        'data-action="delete-plan-row" data-idx="' + idx + '">ðŸ—‘ï¸</button>' +
                        "</td>";

                    frag.appendChild(tr);
                });
                tbody.appendChild(frag);
            }

            attachWeeklyPlanHandlers(panel);
        }

        function attachWeeklyPlanHandlers(panel) {
            panel.addEventListener("click", function (e) {
                const target = e.target;
                const action = target.getAttribute("data-action");

                if (action === "add-plan-row") {
                    addEmptyPlanRow();
                } else if (action === "delete-plan-row") {
                    const idx = target.getAttribute("data-idx");
                    deletePlanRow(idx);
                } else if (action === "save-weekly-plan") {
                    saveWeeklyPlan();
                }
            });
        }

        function addEmptyPlanRow() {
            const panel = document.getElementById("plan-semanal-panel");
            if (!panel) return;

            const tbody = panel.querySelector("tbody");
            if (!tbody) return;

            const idx = tbody.querySelectorAll("tr").length;
            const rowId = "plan-row-" + idx;

            const tr = document.createElement("tr");
            tr.setAttribute("data-idx", idx);

            tr.innerHTML =
                "<td>" +
                '<select class="form-select form-select-sm" id="' + rowId + '-empleado">' +
                HtmlHelpers.getEmpleadoOptionsHtml("", referenceData.empleados) +
                "</select>" +
                "</td>" +
                "<td>" +
                '<select class="form-select form-select-sm text-center" id="' + rowId + '-dia">' +
                HtmlHelpers.getDiaOptionsHtml("") +
                "</select>" +
                "</td>" +
                "<td>" +
                '<input type="time" class="form-control form-control-sm text-center" ' +
                'id="' + rowId + '-hora" step="1800">' +
                "</td>" +
                "<td>" +
                '<input type="number" step="0.5" min="0" ' +
                'class="form-control form-control-sm text-end" ' +
                'id="' + rowId + '-horas">' +
                "</td>" +
                "<td class='text-center'>" +
                '<input type="checkbox" class="form-check-input" ' +
                'id="' + rowId + '-activo" checked>' +
                "</td>" +
                "<td>" +
                '<input type="text" class="form-control form-control-sm" ' +
                'id="' + rowId + '-obs">' +
                "</td>" +
                "<td class='text-center'>" +
                '<button type="button" class="btn btn-outline-danger btn-sm" ' +
                'data-action="delete-plan-row" data-idx="' + idx + '">ðŸ—‘ï¸</button>' +
                "</td>";

            tbody.appendChild(tr);
        }

        function deletePlanRow(idx) {
            const panel = document.getElementById("plan-semanal-panel");
            if (!panel) return;

            const tbody = panel.querySelector("tbody");
            if (!tbody) return;

            const tr = tbody.querySelector('tr[data-idx="' + idx + '"]');
            if (tr) {
                tr.remove();
            }
        }

        function saveWeeklyPlan() {
            const clienteSelect = document.getElementById("field-CLIENTE");
            if (!clienteSelect) return;

            const cliente = clienteSelect.value;
            if (!cliente) {
                if (Alerts) Alerts.showAlert("SeleccionÃ¡ un cliente primero.", "warning");
                return;
            }

            const panel = document.getElementById("plan-semanal-panel");
            if (!panel) return;

            const tbody = panel.querySelector("tbody");
            if (!tbody) return;

            const rows = Array.from(tbody.querySelectorAll("tr"));
            const items = rows.map(function (tr) {
                const idx = tr.getAttribute("data-idx");
                const empleadoSelect = document.getElementById(`plan-row-${idx}-empleado`);
                const diaSelect = document.getElementById(`plan-row-${idx}-dia`);
                const horaInput = document.getElementById(`plan-row-${idx}-hora`);
                const horasInput = document.getElementById(`plan-row-${idx}-horas`);
                const activoCheck = document.getElementById(`plan-row-${idx}-activo`);
                const obsInput = document.getElementById(`plan-row-${idx}-obs`);

                return {
                    empleado: empleadoSelect ? empleadoSelect.value : "",
                    diaSemana: diaSelect ? diaSelect.value : "",
                    horaEntrada: horaInput ? horaInput.value : "",
                    horasPlan: horasInput ? horasInput.value : "",
                    activo: activoCheck ? activoCheck.checked : true,
                    observaciones: obsInput ? obsInput.value : ""
                };
            }).filter(item => item.empleado || item.diaSemana || item.horasPlan);

            UiState.setGlobalLoading(true, "Guardando plan semanal...");
            ApiService.call('saveWeeklyPlanForClient', cliente, items)
                .then(function () {
                    if (Alerts) Alerts.showAlert("âœ… Plan semanal guardado correctamente.", "success");
                    fetchWeeklyPlanForClient();
                })
                .catch(function (err) {
                    if (Alerts) Alerts.showAlert("Error al guardar plan: " + err.message, "danger");
                })
                .finally(function () {
                    UiState.setGlobalLoading(false);
                });
        }

        return {
            init,
            setup,
            fetchWeeklyPlanForClient
        };
    })();

    global.WeeklyPlanPanel = WeeklyPlanPanel;
})(typeof window !== "undefined" ? window : this);


/**
 * Attendance Panels - Consolidated
 * Wrapper para todos los paneles de asistencia
 */

(function (global) {
    const AttendancePanels = (() => {

        function setupWeeklyPlanPanel() {
            // Contenedor donde se mostrarÃ¡ el plan semanal
            const container = document.getElementById('weekly-plan-panel');
            if (!container) return;

            // Limpiar contenido previo
            container.innerHTML = '';

            // Crear una vista basada en cards para cada dÃ­a de la semana
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'row g-3'; // Grid de Bootstrap con gap
            cardWrapper.id = 'weekly-plan-cards';
            container.appendChild(cardWrapper);

            // Cargar los datos del plan semanal desde el backend
            ApiService.call('getWeeklyPlan', 'ASISTENCIA_PLAN', '')
                .then(function (planData) {
                    // Esperamos que planData sea un array de objetos {dia, registros}
                    if (!Array.isArray(planData)) return;
                    planData.forEach(function (day) {
                        const col = document.createElement('div');
                        col.className = 'col-md-4';
                        const card = document.createElement('div');
                        card.className = 'card h-100 shadow-sm';
                        card.innerHTML = `
                            <div class="card-header bg-indigo-100 text-white">
                                <h6 class="mb-0">${day.dia}</h6>
                            </div>
                            <div class="card-body p-2">
                                <ul class="list-group list-group-flush">
                                    ${day.registros.map(r => `<li class="list-group-item py-1 small">${r}</li>`).join('')}
                                </ul>
                            </div>`;
                        col.appendChild(card);
                        cardWrapper.appendChild(col);
                    });
                })
                .catch(function (err) {
                    console.error('Error cargando plan semanal:', err);
                });
        }

        function setupDailyPanel() {
            // Contenedor donde se mostrarÃ¡ la grilla de asistencia diaria
            const container = document.getElementById('daily-attendance-panel');
            if (!container) return;

            // Limpiar contenido previo
            container.innerHTML = '';

            // Crear estructura de la grilla (tabla) dentro del contenedor
            const gridWrapper = document.createElement('div');
            gridWrapper.className = 'card shadow-sm p-3 mb-4'; // Card con sombra y padding
            gridWrapper.innerHTML = `
                <h5 class="card-title mb-3">Asistencia Diaria</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead><tr id="grid-headers"></tr></thead>
                        <tbody id="grid-body"></tbody>
                    </table>
                </div>`;
            container.appendChild(gridWrapper);

            // FunciÃ³n para cargar los registros segÃºn la fecha seleccionada
            function loadAttendance() {
                const dateInput = document.getElementById('field-fecha'); // Asumiendo que el campo de fecha tiene este ID
                const fecha = dateInput ? dateInput.value : '';
                const tipoFormato = 'ASISTENCIA';
                ApiService.call('searchRecords', tipoFormato, fecha)
                    .then(function (records) {
                        if (GridManager) {
                            GridManager.renderGrid(tipoFormato, records || []);
                        }
                    })
                    .catch(function (err) {
                        console.error('Error cargando asistencia:', err);
                        if (GridManager) {
                            GridManager.renderGrid('ASISTENCIA', []);
                        }
                    });
            }

            // Cargar datos al iniciar
            loadAttendance();

            // Si el usuario cambia la fecha, recargar la grilla
            const dateInput = document.getElementById('field-fecha');
            if (dateInput) {
                dateInput.addEventListener('change', loadAttendance);
            }
        }

        return {
            setupWeeklyPlanPanel,
            setupDailyPanel
        };
    })();

    global.AttendancePanels = AttendancePanels;
})(typeof window !== "undefined" ? window : this);


/**
 * Panel de Detalle de Horas - Seguimiento por Empleado
 */
var HoursDetailPanel = (function () {
    let containerId = 'hours-detail-panel';

    function render() {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = `
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 text-primary">
                        <i class="bi bi-clock-history me-2"></i>Seguimiento de Horas por Empleado
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="row g-3 mb-4 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label small text-muted fw-semibold">Empleado</label>
                            <select id="hours-filter-employee" class="form-select">
                                <option value="">Seleccionar Empleado...</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted fw-semibold">Fecha Desde</label>
                            <input type="date" id="hours-filter-start" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted fw-semibold">Fecha Hasta</label>
                            <input type="date" id="hours-filter-end" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <button id="btn-search-hours" class="btn btn-primary w-100">
                                <i class="bi bi-search me-1"></i> Buscar
                            </button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="hours-loading" class="text-center py-5 d-none">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="text-muted mt-2">Cargando registros...</p>
                    </div>

                    <!-- Tabla de Resultados -->
                    <div id="hours-results-container" class="d-none">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 120px;">Acciones</th>
                                        <th>Cliente</th>
                                        <th>Fecha</th>
                                        <th class="text-center">Horas</th>
                                        <th>Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody id="hours-table-body">
                                    <!-- Rows will be injected here -->
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td colspan="3" class="text-end">Total Horas:</td>
                                        <td class="text-center" id="hours-total-sum">0</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- Acciones Globales -->
                        <div class="d-flex justify-content-end mt-3 pt-3 border-top">
                            <button id="btn-bill-hours" class="btn btn-success" disabled>
                                <i class="bi bi-receipt me-1"></i> Generar Factura
                            </button>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="hours-empty-state" class="text-center py-5 d-none">
                        <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                        <p class="text-muted mt-2">No se encontraron registros con los filtros seleccionados.</p>
                    </div>
                </div>
            </div>
        `;

        // Populate Employees
        loadEmployees();

        // Set default dates (current month)
        setDefaultDates();

        // Attach Events
        document.getElementById('btn-search-hours').addEventListener('click', handleSearch);
        document.getElementById('btn-bill-hours').addEventListener('click', () => {
            Alerts.showAlert("Funcionalidad de facturaciÃ³n prÃ³ximamente", "info");
        });
    }

    function setDefaultDates() {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

        document.getElementById('hours-filter-start').valueAsDate = firstDay;
        document.getElementById('hours-filter-end').valueAsDate = lastDay;
    }

    function loadEmployees() {
        // Reuse ReferenceService if available, or fetch fresh
        if (typeof ReferenceService !== 'undefined') {
            ReferenceService.getReferences().then(refs => {
                const select = document.getElementById('hours-filter-employee');
                if (!select) return;

                const employees = refs.empleados || [];
                employees.sort().forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee;
                    option.textContent = employee;
                    select.appendChild(option);
                });
            });
        }
    }

    function handleSearch() {
        const start = document.getElementById('hours-filter-start').value;
        const end = document.getElementById('hours-filter-end').value;
        const employee = document.getElementById('hours-filter-employee').value;

        if (!employee) {
            Alerts.showAlert("Por favor seleccione un empleado", "warning");
            return;
        }

        // UI Loading
        document.getElementById('hours-results-container').classList.add('d-none');
        document.getElementById('hours-empty-state').classList.add('d-none');
        document.getElementById('hours-loading').classList.remove('d-none');

        ApiService.call('getHoursByEmployee', [start, end, employee])
            .then(results => {
                renderTable(results);
            })
            .catch(err => {
                console.error(err);
                Alerts.showAlert("Error al cargar horas: " + err.message, "danger");
            })
            .finally(() => {
                document.getElementById('hours-loading').classList.add('d-none');
            });
    }

    function renderTable(data) {
        const tbody = document.getElementById('hours-table-body');
        const container = document.getElementById('hours-results-container');
        const emptyState = document.getElementById('hours-empty-state');
        const totalSum = document.getElementById('hours-total-sum');
        const btnBill = document.getElementById('btn-bill-hours');

        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            container.classList.add('d-none');
            emptyState.classList.remove('d-none');
            return;
        }

        let total = 0;

        data.forEach(row => {
            const tr = document.createElement('tr');
            const hours = parseFloat(row.horas) || 0;
            total += hours;

            tr.innerHTML = `
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1 btn-edit-hour" data-id="${row.id}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-delete-hour" data-id="${row.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
                <td>${row.cliente || '-'}</td>
                <td>${row.fecha}</td>
                <td class="text-center fw-bold">${hours}</td>
                <td class="text-muted small">${row.observaciones || '-'}</td>
            `;
            tbody.appendChild(tr);
        });

        // Update Total
        totalSum.textContent = total.toFixed(2);

        // Enable Export Button
        const btnExport = document.getElementById('btn-bill-hours');
        if (btnExport) {
            btnExport.innerHTML = '<i class="bi bi-file-earmark-spreadsheet me-1"></i> Exportar CSV';
            btnExport.classList.remove('btn-success');
            btnExport.classList.add('btn-success'); // Keep green or change to other color
            btnExport.disabled = false;

            // Remove old listeners (cloning node is a simple way to clear listeners)
            const newBtn = btnExport.cloneNode(true);
            btnExport.parentNode.replaceChild(newBtn, btnExport);

            newBtn.addEventListener('click', () => exportToCsv(data));
        }

        // Show Table
        container.classList.remove('d-none');
        emptyState.classList.add('d-none');

        // Attach Action Events
        attachActionEvents(data);
    }

    function exportToCsv(data) {
        if (!data || data.length === 0) return;

        // CSV Headers
        const headers = ['ID', 'Fecha', 'Cliente', 'Empleado', 'Horas', 'Observaciones'];

        // CSV Rows
        const rows = data.map(row => [
            row.id,
            row.fecha,
            `"${(row.cliente || '').replace(/"/g, '""')}"`, // Escape quotes
            `"${(row.empleado || '').replace(/"/g, '""')}"`,
            row.horas,
            `"${(row.observaciones || '').replace(/"/g, '""')}"`
        ]);

        // Combine
        const csvContent = [
            headers.join(','),
            ...rows.map(r => r.join(','))
        ].join('\n');

        // Create Blob and Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);

        const timestamp = new Date().toISOString().slice(0, 10);
        link.setAttribute('href', url);
        link.setAttribute('download', `reporte_horas_${timestamp}.csv`);
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function attachActionEvents(data) {
        // Edit
        document.querySelectorAll('.btn-edit-hour').forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.dataset.id;
                const record = data.find(r => r.id == id);
                if (record) {
                    editRecord(id, record);
                }
            });
        });

        // Delete
        document.querySelectorAll('.btn-delete-hour').forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.dataset.id;
                deleteRecord(id);
            });
        });
    }

    function editRecord(id, record) {
        // We need to switch to the Registro view and open the modal
        // First, trigger view change to 'registro'
        const event = new CustomEvent('view-change', { detail: { view: 'registro' } });
        document.dispatchEvent(event);

        // Wait for view to load
        setTimeout(() => {
            // Set format to ASISTENCIA
            const formatSelect = document.getElementById('formato');
            if (formatSelect) {
                formatSelect.value = 'ASISTENCIA';
                formatSelect.dispatchEvent(new Event('change'));
            }

            // Wait for format to load
            setTimeout(() => {
                if (GridManager && FormManager && RecordManager) {
                    const fullRecord = {
                        ID: record.id,
                        FECHA: record.fecha,
                        EMPLEADO: record.empleado,
                        HORAS: record.horas,
                        OBSERVACIONES: record.observaciones,
                        CLIENTE: record.cliente,
                        ASISTENCIA: 'Presente' // Default assumption
                    };

                    // Open modal and load record
                    GridManager.openModal("Editar Registro de Horas", function () {
                        FormManager.renderForm('ASISTENCIA');
                        RecordManager.loadRecordForEdit(id, fullRecord);
                    });
                }
            }, 300);
        }, 300);
    }

    function deleteRecord(id) {
        if (!confirm('Â¿EstÃ¡ seguro de eliminar este registro de horas?')) return;

        UiState.setGlobalLoading(true, "Eliminando...");

        // Use existing delete logic
        // We need to know the format, which is ASISTENCIA
        ApiService.call('deleteRecord', ['ASISTENCIA', id])
            .then(() => {
                Alerts.showAlert("Registro eliminado correctamente", "success");
                handleSearch(); // Refresh table
            })
            .catch(err => {
                Alerts.showAlert("Error al eliminar: " + err.message, "danger");
            })
            .finally(() => {
                UiState.setGlobalLoading(false);
            });
    }

    return {
        render: render
    };
})();


/**
 * Form Manager
 * Gestiona la carga, renderizado y configuraciÃ³n de formularios
 */

(function (global) {
    const FormManager = (() => {
        let currentFormat = null;
        let referenceData = { clientes: [], empleados: [] };

        /**
         * Inicializa el form manager con datos de referencia
         */
        function init(refData) {
            referenceData = refData || { clientes: [], empleados: [] };
        }

        /**
         * Carga los formatos disponibles desde el servidor
         */
        function loadFormats() {
            return ApiService.call('getAvailableFormats')
                .then(function (formats) {
                    if (!Array.isArray(formats) || !formats.length) {
                        renderFormatsOptions(buildLocalFormats());
                        if (Alerts) Alerts.showAlert("No pudimos cargar los formatos del servidor. Se usan formatos locales.", "warning");
                        return;
                    }
                    renderFormatsOptions(formats);
                })
                .catch(function (err) {
                    console.error("Error obteniendo formatos:", err);
                    renderFormatsOptions(buildLocalFormats());
                    if (Alerts) Alerts.showAlert("No pudimos cargar los formatos. Usando definiciones locales.", "warning");
                });
        }

        /**
         * Construye formatos desde definiciones locales
         */
        function buildLocalFormats() {
            return Object.keys(FORM_DEFINITIONS).map(function (id) {
                return { id: id, name: FORM_DEFINITIONS[id].title || id };
            });
        }

        /**
         * Renderiza las opciones del selector de formatos
         */
        function renderFormatsOptions(formats) {
            if (!Array.isArray(formats)) return;
            const select = document.getElementById("formato");
            if (!select) return;

            select.innerHTML = "";
            formats.forEach(function (f) {
                const option = document.createElement("option");
                option.value = f.id;
                option.textContent = f.name;
                select.appendChild(option);
            });

            if (formats.length > 0) {
                currentFormat = formats[0].id;
                select.value = currentFormat;
                renderForm(currentFormat);
            }
        }

        /**
         * Renderiza un formulario especÃ­fico
         * @param {string} tipoFormato - Tipo de formato a renderizar
         * @param {string} containerId - ID del contenedor (opcional, por defecto "form-fields")
         */
        function renderForm(tipoFormato, containerId) {
            currentFormat = tipoFormato;

            if (Alerts) Alerts.clearAlerts();

            const formDef = FORM_DEFINITIONS[tipoFormato];
            const container = document.getElementById(containerId || "form-fields");
            const titleEl = document.getElementById("form-title");
            const sugg = document.getElementById("search-suggestions");

            if (!container) {
                console.error("Container not found:", containerId || "form-fields");
                return;
            }

            container.innerHTML = "";
            if (sugg) {
                sugg.classList.add("d-none");
                sugg.innerHTML = "";
            }

            if (!formDef) {
                if (titleEl) titleEl.textContent = "Registro";
                container.innerHTML =
                    '<p class="text-muted small mb-0">No hay formulario definido para este formato.</p>';
                return;
            }

            if (titleEl) titleEl.textContent = formDef.title;

            formDef.fields.forEach(field => {
                const colDiv = document.createElement("div");
                colDiv.className = "col-12";

                const formGroup = FormRenderer.renderField(field, referenceData);
                colDiv.appendChild(formGroup);
                container.appendChild(colDiv);
            });

            // Autocompletar CUIT para FACTURACION y PAGOS
            if (tipoFormato === "FACTURACION" || tipoFormato === "PAGOS") {
                setupCuitAutocomplete();
            }

            // Setup panels especÃ­ficos por tipo - con timeout para asegurar que el DOM estÃ© listo
            if (tipoFormato === "ASISTENCIA" && global.AttendancePanels) {
                setTimeout(() => {
                    global.AttendancePanels.setupDailyPanel();
                }, 100);
            }

            if (tipoFormato === "ASISTENCIA_PLAN" && global.AttendancePanels) {
                setTimeout(() => {
                    global.AttendancePanels.setupWeeklyPlanPanel();
                }, 100);
            }

            // Actualizar visibilidad del footer
            if (global.FooterManager) {
                global.FooterManager.updateVisibility();
            }
        }

        /**
         * Configura autocompletado de CUIT
         */
        function setupCuitAutocomplete() {
            const rsSelect = document.getElementById("field-RAZÃ“N SOCIAL");
            const cuitInput = document.getElementById("field-CUIT");

            if (rsSelect && cuitInput) {
                rsSelect.addEventListener("change", function () {
                    const selected = this.value;
                    const cli = referenceData.clientes.find(c =>
                        (c.razonSocial || c.nombre) === selected
                    );
                    cuitInput.value = cli ? cli.cuit : "";
                });
            }
        }

        /**
         * Limpia el formulario actual
         */
        function clearForm() {
            if (!currentFormat) return;
            const formDef = FORM_DEFINITIONS[currentFormat];
            if (!formDef) return;

            formDef.fields.forEach(function (field) {
                const input = document.getElementById("field-" + field.id);
                if (!input) return;

                input.classList.remove("is-invalid");

                if (field.type === "boolean") {
                    input.checked = true;
                } else {
                    input.value = "";
                }
            });
        }

        /**
         * Actualiza los datos de referencia
         */
        function updateReferenceData(newRefData) {
            referenceData = newRefData || { clientes: [], empleados: [] };
            if (currentFormat) {
                renderForm(currentFormat);
            }
        }

        /**
         * Obtiene el formato actual
         */
        function getCurrentFormat() {
            return currentFormat;
        }

        return {
            init,
            loadFormats,
            renderForm,
            clearForm,
            updateReferenceData,
            getCurrentFormat
        };
    })();

    global.FormManager = FormManager;
})(typeof window !== "undefined" ? window : this);


/**
 * Record Manager
 * Maneja CRUD de registros (Create, Read, Update, Delete)
 */

(function (global) {
    const RecordManager = (() => {
        let currentMode = "create"; // "create" | "edit"
        let selectedRowNumber = null;

        function enterCreateMode(clear = true) {
            currentMode = "create";
            selectedRowNumber = null;

            if (clear && global.FormManager) {
                global.FormManager.clearForm();
            }

            if (global.SearchManager) {
                global.SearchManager.clearSearch();
            }

            if (global.FooterManager) {
                global.FooterManager.showCreateMode();
            }
        }

        function enterEditMode(id, record) {
            currentMode = "edit";
            selectedRowNumber = id; // Now stores ID instead of rowNumber
            loadRecordIntoForm(record);

            if (global.FooterManager) {
                global.FooterManager.showEditMode();
            }
        }

        function loadRecordForEdit(id, record) {
            enterEditMode(id, record);
        }

        function loadRecordIntoForm(record) {
            Object.keys(record).forEach(function (fieldId) {
                // Skip ID field - it's not editable
                if (fieldId === 'ID') return;

                const input = document.getElementById("field-" + fieldId);
                if (!input) return;

                const value = record[fieldId];

                if (input.type === "checkbox") {
                    // Recognize various truthy values including normalized strings
                    input.checked = value === true ||
                        value === "TRUE" ||
                        value === "true" ||  // Added for normalized boolean
                        value === "Activo" ||
                        value === 1 ||
                        value === "1";
                } else {
                    // For text inputs, use the value as-is (even if empty string)
                    input.value = value !== null && value !== undefined ? value : "";
                }
            });
        }

        function saveRecord() {
            const tipoFormato = global.FormManager ? global.FormManager.getCurrentFormat() : null;
            if (!tipoFormato) {
                if (Alerts) Alerts.showAlert("No hay formato seleccionado.", "warning");
                return;
            }

            const formDef = FORM_DEFINITIONS[tipoFormato];
            if (!formDef) return;

            const record = {};
            let hasErrors = false;

            formDef.fields.forEach(function (field) {
                const input = document.getElementById("field-" + field.id);
                if (!input) return;

                input.classList.remove("is-invalid");

                let value;
                if (field.type === "boolean") {
                    value = input.checked;
                } else {
                    value = input.value.trim();
                }

                record[field.id] = value;
            });

            if (hasErrors) {
                if (Alerts) Alerts.showAlert("Por favor completÃ¡ los campos requeridos.", "warning");
                return;
            }

            UiState.setGlobalLoading(true, "Guardando...");

            if (currentMode === "edit" && selectedRowNumber) {
                // Update existing (selectedRowNumber now contains ID)
                ApiService.call('updateRecord', tipoFormato, selectedRowNumber, record)
                    .then(function () {
                        if (Alerts) Alerts.showAlert("âœ… Registro actualizado correctamente.", "success");
                        enterCreateMode(true);
                        if (ReferenceService) {
                            ReferenceService.load().then(function () {
                                if (global.FormManager) {
                                    global.FormManager.updateReferenceData(ReferenceService.get());
                                }
                            });
                        }
                    })
                    .catch(function (err) {
                        if (Alerts) Alerts.showAlert("Error al actualizar: " + err.message, "danger");
                    })
                    .finally(function () {
                        UiState.setGlobalLoading(false);
                    });
            } else {
                // Create new
                ApiService.call('saveFormRecord', tipoFormato, record)
                    .then(function () {
                        if (Alerts) Alerts.showAlert("âœ… Registro guardado correctamente.", "success");
                        enterCreateMode(true);
                        if (ReferenceService) {
                            ReferenceService.load().then(function () {
                                if (global.FormManager) {
                                    global.FormManager.updateReferenceData(ReferenceService.get());
                                }
                            });
                        }
                    })
                    .catch(function (err) {
                        if (Alerts) Alerts.showAlert("Error al guardar: " + err.message, "danger");
                    })
                    .finally(function () {
                        UiState.setGlobalLoading(false);
                    });
            }
        }

        function deleteRecord() {
            if (currentMode !== "edit" || !selectedRowNumber) {
                if (Alerts) Alerts.showAlert("No hay registro seleccionado para eliminar.", "warning");
                return;
            }

            if (!confirm("Â¿EstÃ¡s seguro de que querÃ©s eliminar este registro?")) {
                return;
            }

            const tipoFormato = global.FormManager ? global.FormManager.getCurrentFormat() : null;
            if (!tipoFormato) return;

            UiState.setGlobalLoading(true, "Eliminando...");

            ApiService.call('deleteRecord', tipoFormato, selectedRowNumber)
                .then(function () {
                    if (Alerts) Alerts.showAlert("âœ… Registro eliminado correctamente.", "success");
                    enterCreateMode(true);
                    if (ReferenceService) {
                        ReferenceService.load().then(function () {
                            if (global.FormManager) {
                                global.FormManager.updateReferenceData(ReferenceService.get());
                            }
                        });
                    }
                })
                .catch(function (err) {
                    if (Alerts) Alerts.showAlert("Error al eliminar: " + err.message, "danger");
                })
                .finally(function () {
                    UiState.setGlobalLoading(false);
                });
        }

        function cancelEdit() {
            enterCreateMode(true);
        }

        return {
            enterCreateMode,
            loadRecordForEdit,
            saveRecord,
            deleteRecord,
            cancelEdit
        };
    })();

    global.RecordManager = RecordManager;
})(typeof window !== "undefined" ? window : this);


/**
 * Main application - Reduced version
 * Bootstraps and connects all modules
 * 
 * Dependencies loaded via bundle (in order):
 * - formDefinitions.js
 * - apiService.js  
 * - referenceService.js
 * - ui/alerts.js
 * - ui/state.js
 * - ui/formRenderer.js
 * - ui/footer.js
 * - utils/htmlHelpers.js
 * - forms/formManager.js
 * - search/searchManager.js
 * - records/recordManager.js
 * - attendance/weeklyPlanPanel.js
 * - attendance/attendancePanels.js
 */

(() => {
  if (typeof document === 'undefined') {
    return;
  }

  // ===== Bootstrap Application =====

  function initApp() {
    // 1. Load formats immediately
    if (FormManager) {
      FormManager.loadFormats().then(function () {
        // DespuÃ©s de cargar los formatos, cargar la grilla del primer formato
        const formatoSelect = document.getElementById("formato");
        if (formatoSelect && formatoSelect.value) {
          const tipoFormato = formatoSelect.value;

          // Cargar registros y mostrar en grilla
          ApiService.call("searchRecords", tipoFormato, "")
            .then(function (records) {
              if (GridManager) {
                GridManager.renderGrid(tipoFormato, records || []);
              }
            })
            .catch(function (err) {
              console.error("Error cargando registros iniciales:", err);
              if (GridManager) {
                GridManager.renderGrid(tipoFormato, []);
              }
            });
        }
      });
    }

    // 2. Load reference data
    ReferenceService.load()
      .then(function () {
        const refData = ReferenceService.get();

        // Initialize modules with reference data
        if (FormManager) {
          FormManager.init(refData);
          // Update UI with loaded data
          FormManager.updateReferenceData(refData);
        }

        if (WeeklyPlanPanel) {
          WeeklyPlanPanel.init(refData);
        }
      })
      .catch(function (err) {
        console.error("Error loading reference data:", err);
      });

    // Setup event handlers
    setupEventHandlers();
  }

  function setupEventHandlers() {
    // Format selector - Cargar grilla en lugar de formulario
    const formatoSelect = document.getElementById("formato");
    if (formatoSelect) {
      formatoSelect.addEventListener("change", function () {
        const tipoFormato = this.value;
        if (!tipoFormato) return;

        // Cargar registros y mostrar en grilla
        ApiService.call("searchRecords", tipoFormato, "")
          .then(function (records) {
            if (GridManager) {
              GridManager.renderGrid(tipoFormato, records || []);
            }
          })
          .catch(function (err) {
            console.error("Error cargando registros:", err);
            if (GridManager) {
              GridManager.renderGrid(tipoFormato, []);
            }
          });
      });
    }

    // Search input - Filtrar grilla
    const searchInput = document.getElementById("search-query");
    if (searchInput) {
      searchInput.addEventListener("input", function () {
        const formatoSelect = document.getElementById("formato");
        const tipoFormato = formatoSelect ? formatoSelect.value : null;

        if (!tipoFormato) {
          if (this.value.length > 0 && Alerts) {
            Alerts.showAlert("Selecciona un formato primero para buscar", "warning");
          }
          return;
        }

        // Buscar y actualizar grilla
        ApiService.call("searchRecords", tipoFormato, this.value)
          .then(function (records) {
            if (GridManager) {
              GridManager.renderGrid(tipoFormato, records || []);
            }
          })
          .catch(function (err) {
            console.error("Error en bÃºsqueda:", err);
          });
      });
    }

    // BotÃ³n Nuevo - Abrir modal
    const btnNuevo = document.getElementById("btn-nuevo");
    if (btnNuevo) {
      btnNuevo.addEventListener("click", function () {
        const formatoSelect = document.getElementById("formato");
        const tipoFormato = formatoSelect ? formatoSelect.value : null;

        if (!tipoFormato) {
          if (Alerts) {
            Alerts.showAlert("Selecciona un formato primero", "warning");
          }
          return;
        }

        // Abrir modal y renderizar formulario en el callback
        if (GridManager) {
          GridManager.openModal("Nuevo Registro", function () {
            if (FormManager) {
              FormManager.renderForm(tipoFormato);
              FormManager.clearForm();
            }
          });
        }
      });
    }

    // BotÃ³n Refresh
    const btnRefresh = document.getElementById("btn-refresh");
    if (btnRefresh) {
      btnRefresh.addEventListener("click", function () {
        if (GridManager) {
          GridManager.refreshGrid();
        }
      });
    }

    // Modal - BotÃ³n Cerrar
    const btnCloseModal = document.getElementById("btn-close-modal");
    if (btnCloseModal) {
      btnCloseModal.addEventListener("click", function () {
        if (GridManager) {
          GridManager.closeModal();
        }
      });
    }

    // Modal - BotÃ³n Cancelar
    const btnCancelarModal = document.getElementById("btn-cancelar-modal");
    if (btnCancelarModal) {
      btnCancelarModal.addEventListener("click", function () {
        if (GridManager) {
          GridManager.closeModal();
        }
      });
    }

    // Modal - BotÃ³n Guardar
    const btnGuardarModal = document.getElementById("btn-guardar-modal");
    if (btnGuardarModal) {
      btnGuardarModal.addEventListener("click", function () {
        if (RecordManager) {
          RecordManager.saveRecord();
          // Cerrar modal despuÃ©s de guardar
          setTimeout(() => {
            if (GridManager) {
              GridManager.closeModal();
              GridManager.refreshGrid();
            }
          }, 500);
        }
      });
    }

    // Modal - BotÃ³n Eliminar
    const btnEliminarModal = document.getElementById("btn-eliminar-modal");
    if (btnEliminarModal) {
      btnEliminarModal.addEventListener("click", function () {
        if (RecordManager) {
          RecordManager.deleteRecord();
          // Cerrar modal despuÃ©s de eliminar
          setTimeout(() => {
            if (GridManager) {
              GridManager.closeModal();
              GridManager.refreshGrid();
            }
          }, 500);
        }
      });
    }

    // Cerrar modal al hacer clic fuera
    const modalOverlay = document.getElementById("form-modal");
    if (modalOverlay) {
      modalOverlay.addEventListener("click", function (e) {
        if (e.target === modalOverlay && GridManager) {
          GridManager.closeModal();
        }
      });
    }

    // Footer buttons
    if (Footer) {
      Footer.render();
    }

    // Tab Handling
    const tabInformes = document.getElementById('informes-tab');
    const tabGestion = document.getElementById('gestion-tab');
    const footerContainer = document.getElementById('footer-container');

    if (tabInformes) {
      tabInformes.addEventListener('shown.bs.tab', function (e) {
        // Initialize Hours Panel when tab is shown
        if (HoursDetailPanel) {
          HoursDetailPanel.render();
        }
        // Hide footer in Reports tab (optional, or keep it if needed)
        if (footerContainer) footerContainer.classList.add('d-none');
      });
    }

    if (tabGestion) {
      tabGestion.addEventListener('shown.bs.tab', function (e) {
        // Show footer in Management tab
        if (footerContainer) footerContainer.classList.remove('d-none');
      });
    }
    const btnSave = document.getElementById("btn-grabar");
    if (btnSave) {
      btnSave.addEventListener("click", function () {
        if (RecordManager) {
          RecordManager.saveRecord();
        }
      });
    }

    const btnCancel = document.getElementById("btn-limpiar");
    if (btnCancel) {
      btnCancel.addEventListener("click", function () {
        if (RecordManager) {
          RecordManager.cancelEdit();
        }
      });
    }

    const btnDelete = document.getElementById("btn-eliminar");
    if (btnDelete) {
      btnDelete.addEventListener("click", function () {
        if (RecordManager) {
          RecordManager.deleteRecord();
        }
      });
    }

    // Botones superiores (duplicados para acceso rÃ¡pido)
    const btnSaveTop = document.getElementById("btn-grabar-top");
    if (btnSaveTop) {
      btnSaveTop.addEventListener("click", function () {
        if (RecordManager) {
          RecordManager.saveRecord();
        }
      });
    }

    const btnCancelTop = document.getElementById("btn-limpiar-top");
    if (btnCancelTop) {
      btnCancelTop.addEventListener("click", function () {
        if (RecordManager) {
          RecordManager.cancelEdit();
        }
      });
    }

    const btnDeleteTop = document.getElementById("btn-eliminar-top");
    if (btnDeleteTop) {
      btnDeleteTop.addEventListener("click", function () {
        if (RecordManager) {
          RecordManager.deleteRecord();
        }
      });
    }

    // Sidebar Initialization
    if (Sidebar) {
      Sidebar.init();

      // Handle view changes
      document.addEventListener('view-change', (e) => {
        const viewId = e.detail.view;
        const pageTitle = document.getElementById('page-title');

        // Update Title
        if (pageTitle) {
          pageTitle.textContent = viewId.charAt(0).toUpperCase() + viewId.slice(1);
        }

        // Hide all views
        document.querySelectorAll('.view-section').forEach(el => {
          el.classList.add('d-none');
        });

        // Show target view
        const targetView = document.getElementById(`view-${viewId}`);
        if (targetView) {
          targetView.classList.remove('d-none');
        }

        // Initialize view-specific content
        if (viewId === 'reportes' && HoursDetailPanel) {
          HoursDetailPanel.render();
        }
      });
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
  } else {
    initApp();
  }
})();

</script>
